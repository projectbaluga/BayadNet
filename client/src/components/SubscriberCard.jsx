import React from 'react';
import {
  Clock,
  Edit,
  MessageCircle,
  FileText,
  Trash2,
  CheckCircle2,
  Image as ImageIcon,
  Send
} from 'lucide-react';

const SubscriberCard = ({
  subscriber,
  onPay,
  onHistory,
  onOpenChat,
  onViewReceipt,
  onEdit,
  onDelete,
  onViewDetails,
  userRole
}) => {
  const handleSendReminder = () => {
    const amount = subscriber.status === 'Partial' ? subscriber.remainingBalance : subscriber.amountDue;
    const message = `Hi ${subscriber.name}, your bill for ${subscriber.currentMonthName || 'this month'} is ${subscriber.status}. Total Due: ₱${amount.toLocaleString()} (after ₱${subscriber.rebate.toLocaleString()} rebate). Thank you!`;

    if (subscriber.messengerId) {
      const url = `https://m.me/${subscriber.messengerId}?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    } else {
      if (subscriber.contactNo) {
        const smsUrl = `sms:${subscriber.contactNo}?body=${encodeURIComponent(message)}`;
        window.open(smsUrl, '_blank');
      } else {
        const url = `https://m.me/?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
      }
    }
  };

  const handleDownloadSOA = () => {
    const amount = subscriber.status === 'Partial' ? subscriber.remainingBalance : subscriber.amountDue;
    const printWindow = window.open('', '_blank');
    if (!printWindow) return;

    const content = `
      <html>
        <head>
          <title>SOA - ${subscriber.name}</title>
          <style>
            body { font-family: sans-serif; padding: 40px; color: #334155; }
            .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
            .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
            .total { font-size: 24px; font-weight: bold; color: #4f46e5; margin-top: 30px; }
            .footer { margin-top: 50px; font-size: 12px; color: #94a3b8; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Statement of Account</h1>
            <p>Subscriber: <strong>${subscriber.name}</strong></p>
            <p>Billing Period: ${subscriber.currentMonthName || 'Current Month'}</p>
          </div>
          <div class="row"><span>Monthly Rate</span><span>₱${subscriber.rate.toLocaleString()}</span></div>
          <div class="row"><span>Outage Rebate (${subscriber.daysDown} days)</span><span>-₱${subscriber.rebate.toLocaleString()}</span></div>
          <div class="row"><span>Total Amount for Period</span><span>₱${subscriber.amountDue.toLocaleString()}</span></div>
          <div class="row"><span>Payments Made</span><span>₱${(subscriber.amountDue - (subscriber.status === 'Partial' ? subscriber.remainingBalance : (subscriber.status === 'Paid' ? 0 : subscriber.amountDue))).toLocaleString()}</span></div>
          <div class="total flex justify-between"><span>Remaining Balance</span><span>₱${(subscriber.status === 'Paid' ? 0 : amount).toLocaleString()}</span></div>
          <div class="footer">Generated by BayadNet Pro on ${new Date().toLocaleDateString()}</div>
        </body>
      </html>
    `;

    printWindow.document.write(content);
    printWindow.document.close();

    const checkReady = setInterval(() => {
      if (printWindow.document.readyState === 'complete') {
        clearInterval(checkReady);
        printWindow.print();
      }
    }, 100);
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'Paid': return 'bg-emerald-500/10 text-emerald-600 border-emerald-500/20';
      case 'Overdue': return 'bg-rose-500/10 text-rose-600 border-rose-500/20';
      case 'Due Today': return 'bg-orange-500/10 text-orange-600 border-orange-500/20';
      case 'Partial': return 'bg-amber-500/10 text-amber-600 border-amber-500/20';
      default: return 'bg-slate-500/10 text-slate-600 border-slate-500/20';
    }
  };

  const isPaid = subscriber.status === 'Paid';
  const unreadCount = subscriber.reports ? subscriber.reports.filter(r => !r.readBy || r.readBy.length <= 1).length : 0;
  const amount = subscriber.status === 'Partial' ? subscriber.remainingBalance : (isPaid ? 0 : subscriber.amountDue);

  return (
    <div className="bg-white rounded-2xl border border-slate-100 p-3 flex items-center justify-between gap-4 hover:shadow-lg hover:border-indigo-100 transition-all group">
      {/* Left: Name & Info - Clickable for details */}
      <div
        className="flex-1 min-w-0 cursor-pointer"
        onClick={() => onViewDetails && onViewDetails(subscriber)}
      >
        <div className="flex items-center gap-2">
          <h3 className="font-black text-slate-900 truncate tracking-tight group-hover:text-indigo-600 transition-colors">
            {subscriber.name}
          </h3>
          <span className="text-[9px] font-bold text-slate-300 uppercase tracking-widest whitespace-nowrap">
            C: {subscriber.cycle}
          </span>
        </div>
        <div className="flex items-center gap-2 mt-0.5">
          <span className={`px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-widest border ${getStatusColor(subscriber.status)}`}>
            {subscriber.status}
          </span>
          {unreadCount > 0 && (
            <span className="bg-amber-100 text-amber-600 text-[8px] font-black px-1.5 py-0.5 rounded-full uppercase">
              {unreadCount} Issue{unreadCount > 1 ? 's' : ''}
            </span>
          )}
        </div>
      </div>

      {/* Middle: Amount - Clickable for details */}
      <div
        className="text-right min-w-[90px] px-4 border-l border-r border-slate-50 cursor-pointer"
        onClick={() => onViewDetails && onViewDetails(subscriber)}
      >
        <p className="text-[8px] text-slate-400 font-black uppercase tracking-tighter">Amount Due</p>
        <p className={`text-sm font-black ${isPaid ? 'text-emerald-500' : 'text-indigo-600'}`}>
          ₱{amount.toLocaleString()}
        </p>
      </div>

      {/* Right: Actions */}
      <div className="flex items-center gap-1.5">
        <div className="flex items-center gap-1 pr-2">
          <button
            onClick={() => onHistory(subscriber)}
            className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all"
            title="History"
          >
            <Clock className="w-4 h-4" />
          </button>

          {userRole === 'admin' && (
            <button
              onClick={() => onEdit(subscriber)}
              className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all"
              title="Edit"
            >
              <Edit className="w-4 h-4" />
            </button>
          )}

          <button
            onClick={() => onOpenChat(subscriber)}
            className={`p-2 rounded-lg transition-all relative ${unreadCount > 0 ? 'text-amber-500 bg-amber-50' : 'text-slate-400 hover:text-indigo-600 hover:bg-indigo-50'}`}
            title="Chat"
          >
            <MessageCircle className="w-4 h-4" />
          </button>

          {(userRole === 'admin' || userRole === 'staff') && (
            <>
              <button
                onClick={handleDownloadSOA}
                className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all"
                title="SOA"
              >
                <FileText className="w-4 h-4" />
              </button>
              <button
                onClick={handleSendReminder}
                className="p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 rounded-lg transition-all"
                title="Send Reminder"
              >
                <Send className="w-4 h-4" />
              </button>
            </>
          )}

          {subscriber.hasReceipt && (
            <button
              onClick={() => {
                const latestReceipt = subscriber.payments
                  ?.filter(p => p.month === (subscriber.currentMonthName || 'February 2026') && p.receiptImage)
                  .pop();
                if (latestReceipt) onViewReceipt(latestReceipt.receiptImage);
              }}
              className="p-2 text-emerald-500 hover:bg-emerald-50 rounded-lg transition-all"
              title="Receipt"
            >
              <ImageIcon className="w-4 h-4" />
            </button>
          )}

          {userRole === 'admin' && (
            <button
              onClick={() => onDelete(subscriber._id)}
              className="p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all"
              title="Archive"
            >
              <Trash2 className="w-4 h-4" />
            </button>
          )}
        </div>

        {!isPaid ? (
          (userRole === 'admin' || userRole === 'staff') && (
            <button
              onClick={() => onPay(subscriber)}
              className="bg-indigo-600 text-white text-[10px] font-black px-4 py-2 rounded-xl hover:bg-indigo-700 active:scale-95 transition-all uppercase tracking-widest shadow-lg shadow-indigo-100"
            >
              Pay
            </button>
          )
        ) : (
          <div className="bg-emerald-50 text-emerald-600 p-2 rounded-xl border border-emerald-100" title="Settled">
            <CheckCircle2 className="w-4 h-4" />
          </div>
        )}
      </div>
    </div>
  );
};

export default SubscriberCard;
